<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leads Management Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    {% load static %}
    {# Assuming admin_dashboard.css exists and provides core styling, if not, move relevant styles here #}
    <link rel="stylesheet" href="{% static 'css/admin_dashboard.css' %}"> 
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"> {# Added Bootstrap Icons #}
    <style>
/* --- Kripalu Innovations Theme Variables (adjust to match your admin_dashboard.css if needed) --- */
:root {
    --ki-primary-blue: #0A2E5B; /* Retain the strong primary blue */
    --ki-secondary-gold: #FFD700; /* Bright, vibrant gold */
    --ki-dark-gold: #CCAA00; /* A darker shade of gold for hover/active */
    --ki-light-gold: #FFFBE6; /* Very light, almost white gold tint for backgrounds */

    --primary: var(--ki-primary-blue);
    --primary-light: #eef2ff; /* Keeping original light blue for some elements for contrast */
    --secondary: var(--ki-secondary-gold); /* Now the prominent gold */
    
    --success: #28a745; /* Bootstrap success green */
    --danger: #dc3545; /* Bootstrap danger red */
    --warning: #ffc107; /* Bootstrap warning yellow */
    --info: #17a2b8; /* Bootstrap info cyan */
    --dark: #212529; /* Dark grey for text */
    --light: #FDFDFD; /* Very subtle off-white for body background - almost white */
    --card-background: #FFFFFF; /* Pure white for cards and main panels */
    --gray: #6c757d; /* Standard muted text */
    --gray-light: #e0e0e0; /* Slightly lighter grey for subtle borders */
    --border-radius: 8px;
    --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.04); /* Even softer shadow */
    --transition: all 0.3s ease;

    /* Define RGB for rgba colors */
    --primary-rgb: 10, 46, 91;
    --secondary-rgb: 255, 215, 0;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Inter', sans-serif;
    background-color: var(--light); /* Subtle off-white body background */
    color: var(--dark);
    line-height: 1.6;
}

/* Main container */
.container {
    padding: 24px;
    width: 100%;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    max-width: 1600px; /* Increased max-width */
    margin: 0 auto;
}

/* Header */
.dashboard-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
    flex-wrap: wrap;
    gap: 15px;
}

.dashboard-header h1 {
    font-size: 28px;
    font-weight: 700;
    color: var(--primary); /* Retain primary blue for main heading */
    display: flex;
    align-items: center;
    gap: 10px;
}
.dashboard-header h1 i {
    color: var(--secondary); /* Golden icon for main heading */
}

/* Buttons */
.btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 10px 20px;
    border-radius: var(--border-radius);
    font-size: 15px;
    font-weight: 500;
    cursor: pointer;
    transition: var(--transition);
    text-decoration: none;
    border: none;
    gap: 8px;
}

.btn-primary {
    background-color: var(--primary); /* Primary blue for main actions */
    color: white;
}

.btn-primary:hover {
    background-color: #08244e; /* Slightly darker blue on hover */
    transform: translateY(-2px);
    box-shadow: var(--box-shadow);
}

.btn-secondary {
    background-color: var(--gray); /* Grey for less prominent actions */
    color: white;
}
.btn-secondary:hover {
    background-color: #5a6268;
    transform: translateY(-2px);
    box-shadow: var(--box-shadow);
}

/* New: Active state for filter buttons */
.btn.active {
    background-color: var(--primary); /* Active button is primary blue */
    color: white;
    /* You might want a stronger shadow or slight transformation here too */
    box-shadow: 0 4px 12px rgba(var(--primary-rgb), 0.2);
}

/* Specific colors for new filter buttons */
.btn-warning { /* Used for Pending Leads */
    background-color: var(--warning);
    color: var(--dark); /* Dark text for readability on yellow */
}
.btn-warning:hover {
    background-color: #e0a800; /* Darker yellow on hover */
    color: var(--dark);
    transform: translateY(-2px);
    box-shadow: var(--box-shadow);
}
.btn-info { /* Used for All Leads */
    background-color: var(--info);
    color: white;
}
.btn-info:hover {
    background-color: #138496; /* Darker cyan on hover */
    color: white;
    transform: translateY(-2px);
    box-shadow: var(--box-shadow);
}


/* Date Filter Bar */
.date-filter-bar {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 24px;
    background: var(--card-background); /* White background */
    padding: 15px 20px;
    border-radius: var(--border-radius);
    box-shadow: var(--box-shadow);
    border: 1px solid var(--gray-light); /* Light border */
    flex-wrap: wrap;
}
.date-filter-bar label {
    font-weight: 500;
    color: var(--dark);
    margin-right: 5px;
    white-space: nowrap;
}
.date-filter-bar input[type="date"] {
    padding: 8px 12px;
    border: 1px solid var(--gray-light);
    border-radius: var(--border-radius);
    font-size: 14px;
    color: var(--dark);
    transition: border-color 0.3s ease, box-shadow 0.3s ease; /* Added box-shadow to transition */
    flex-grow: 1;
    max-width: 180px;
    background-color: var(--card-background); /* Ensure input background is white */
}
.date-filter-bar input[type="date"]:focus {
    outline: none;
    border-color: var(--secondary); /* Golden border on focus */
    box-shadow: 0 0 0 3px rgba(var(--secondary-rgb), 0.2); /* Soft golden focus ring */
}
.date-filter-bar .btn {
    height: fit-content;
}

/* Stats cards */
.stats-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin-bottom: 24px;
}

.stat-card {
    background: var(--card-background); /* White background */
    padding: 20px;
    border-radius: var(--border-radius);
    box-shadow: var(--box-shadow);
    transition: var(--transition);
    border: 1px solid var(--gray-light); /* Light border */
}

.stat-card:hover {
    transform: translateY(-3px);
    /* Soft golden glow on hover */
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1), 0 0 15px rgba(var(--secondary-rgb), 0.2); 
    border-color: var(--secondary); /* Golden border on hover */
}

.stat-card h3 {
    margin: 0 0 8px 0;
    font-size: 15px;
    font-weight: 600;
    color: var(--gray);
}

.stat-card p {
    margin: 0;
    font-size: 28px;
    font-weight: 700;
    color: var(--primary); /* Numbers in primary blue for emphasis */
}

/* NEW: Specific colors for lead stats */
.stat-new-leads {
    color: #1976d2; /* A shade of blue for new */
}

.stat-contacted-leads {
    color: #ff8f00; /* An orange for contacted */
}

.stat-converted-leads {
    color: #198754; /* A green for converted */
}


/* Table container */
.table-container {
    flex: 1;
    overflow: auto; /* Allows horizontal scrolling for the table if content exceeds width */
    position: relative;
    border-radius: var(--border-radius);
    background: var(--card-background); /* White background */
    box-shadow: var(--box-shadow);
    border: 1px solid var(--gray-light); /* Light border */
}

/* Table styles */
.leads-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    font-size: 14px;
}

.leads-table th {
    position: sticky;
    top: 0;
    z-index: 10;
    background-color: var(--light); /* Very subtle off-white for sticky header */
    padding: 14px 16px;
    text-align: left;
    font-weight: 600;
    color: var(--gray);
    border-bottom: 1px solid var(--gray-light);
    white-space: nowrap;
}

.leads-table td {
    padding: 12px 16px;
    border-bottom: 1px solid var(--gray-light);
    vertical-align: middle;
}

.leads-table tr:last-child td {
    border-bottom: none;
}

/* Clickable rows */
.clickable-row {
    cursor: pointer;
    transition: background-color 0.3s ease; /* Only background color for smoother flash */
}

.clickable-row:hover {
    background-color: var(--ki-light-gold); /* Very subtle golden tint on hover */
}

/* --- ADJUSTED Status and Priority Badges for better highlight --- */
.badge {
    display: inline-block;
    padding: 6px 12px;
    border-radius: 25px; /* Fully rounded pill shape */
    font-size: 12px;
    font-weight: 600;
    text-transform: capitalize;
    letter-spacing: 0.5px;
    min-width: 80px; /* Ensure a consistent minimum width */
    text-align: center; /* Center the text within the badge */
    transition: background-color 0.2s ease, color 0.2s ease; /* Smooth transition for hover effects if added */
}

/* Status colors - Adjusted for more vibrancy and contrast */
.status-new { 
    background-color: #2196F3; /* Medium blue */
    color: white; /* White text for contrast */
} 
.status-contacted { 
    background-color: #FF9800; /* Bright orange */
    color: white; /* White text for contrast */
} 
.status-qualified { 
    background-color: #4CAF50; /* Green */
    color: white; /* White text for contrast */
} 
.status-lost { 
    background-color: #F44336; /* Red */
    color: white; /* White text for contrast */
} 
.status-won { 
    background-color: #4CAF50; /* Green (same as qualified, or a distinct success green) */
    color: white; 
} 
/* Add a specific "pending" if you use it */
.status-pending { 
    background-color: #9E9E9E; /* Grey */
    color: white; 
}

/* Priority colors - Adjusted for more vibrancy and contrast */
.priority-high { 
    background-color: #E91E63; /* Pink-red for high urgency */
    color: white; 
}
.priority-medium { 
    background-color: #FFC107; /* Amber/Yellow for medium */
    color: #333; /* Darker text for readability on yellow */
}
.priority-low { 
    background-color: #8BC34A; /* Light green for low */
    color: white; 
}


/* Select dropdown */
.select-dropdown {
    padding: 8px 14px;
    font-size: 14px;
    border: 1px solid var(--gray-light);
    border-radius: var(--border-radius);
    background-color: var(--card-background); /* White background */
    color: var(--dark);
    cursor: pointer;
    transition: var(--transition);
    max-width: 180px;
}

.select-dropdown:hover {
    border-color: var(--secondary); /* Golden border on hover */
}
.select-dropdown:focus {
    outline: none;
    border-color: var(--secondary); /* Golden border on focus */
    box-shadow: 0 0 0 3px rgba(var(--secondary-rgb), 0.2);
}

/* Time indicator */
.time-ago {
    font-size: 13px;
    color: var(--gray);
    white-space: nowrap;
}

/* Empty state */
.empty-state {
    padding: 40px;
    text-align: center;
    color: var(--gray);
    font-size: 1.1em;
    font-weight: 500;
}

/* Loading state */
.loading {
    color: var(--primary); /* Primary blue for loading text */
    font-size: 13px;
    padding: 8px;
    display: inline-block;
}

/* Section header */
.section-header {
    margin: 24px 0 16px;
    font-size: 22px;
    font-weight: 700;
    color: var(--primary); /* Primary blue for section headers */
}

/* Contact info styling */
.contact-info {
    display: flex;
    flex-direction: column;
}

.contact-info div {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* Name with role */
.contact-name {
    font-weight: 600;
    color: var(--dark);
}

/* Sort indicator */
.sort-indicator {
    margin-left: 4px;
    color: var(--secondary); /* Golden sort indicator */
}

/* No-click area */
.no-click {
    pointer-events: auto;
}

/* Responsive adjustments */
@media (max-width: 992px) {
    .dashboard-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 15px;
    }
    .dashboard-header .btn {
        width: 100%;
    }
    .date-filter-bar {
        flex-direction: column;
        align-items: stretch;
    }
    .date-filter-bar label {
        width: 100%;
        margin-bottom: 5px;
    }
    .date-filter-bar input[type="date"],
    .date-filter-bar .btn {
        max-width: 100%; /* Ensure inputs and buttons take full width */
    }
}

@media (max-width: 768px) {
    .container {
        padding: 16px; /* Slightly less padding on smaller screens */
    }
    .dashboard-header h1 {
        font-size: 24px; /* Adjust header font size */
    }
    .stats-container {
        grid-template-columns: 1fr; /* Stack stat cards vertically */
        gap: 25px; /* Increased grid gap */
    }
    /* Explicit margin-bottom for stat cards on mobile for more space */
    .stat-card {
        margin-bottom: 25px; /* Increased vertical space between stacked cards */
    }
    .stat-card:last-child {
        margin-bottom: 0; /* Ensures no extra margin at the bottom of the last card */
    }
    
    /* Table specific adjustments for small screens (cards-like display) */
    .leads-table {
        display: block;
        width: 100%; /* Ensure table takes full width */
        overflow-x: auto; /* Fallback for very narrow content if needed, though block display should handle most */
    }
    .leads-table thead {
        /* Hide table header but keep it accessible for screen readers */
        position: absolute;
        top: -9999px;
        left: -9999px;
    }
    .leads-table tbody {
        display: block; /* Make tbody a block to stack rows */
        width: 100%;
    }
    .leads-table tr { 
        display: block; /* Each row becomes a block-level element */
        border: 1px solid var(--gray-light);
        margin-bottom: 15px; /* Space between table rows acting as cards */
        border-radius: var(--border-radius);
        box-shadow: var(--box-shadow);
        padding: 15px; /* Add padding to each row-card */
    }
    .leads-table td { 
        display: block; /* Each cell becomes a block-level element */
        border-bottom: 1px solid var(--gray-light);
        position: relative;
        padding-left: 48%; /* Space for the pseudo-element label */
        text-align: right;
        padding-top: 8px; /* Added padding for better spacing in stacked cells */
        padding-bottom: 8px; /* Added padding for better spacing in stacked cells */
        word-wrap: break-word; /* Ensure long words break */
        white-space: normal; /* Allow text to wrap */
    }
    .leads-table td:last-child {
        border-bottom: none; /* No border for the last cell in a row */
    }
    .leads-table td:before { 
        position: absolute; /* Keep position absolute for label */
        top: 8px; /* Align with new padding */
        left: 15px; /* Align label to the left of the row-card */
        width: 45%; 
        padding-right: 10px; 
        white-space: nowrap; /* Prevent label from wrapping */
        text-align: left;
        font-weight: 600;
        color: var(--gray);
    }
    
    /* Specific content for pseudo-elements */
    /* Updated pseudo-elements after column removal */
    .leads-table td:nth-of-type(1):before { content: "Select:"; } /* Checkbox column */
    .leads-table td:nth-of-type(2):before { content: "Contact Name:"; }
    .leads-table td:nth-of-type(3):before { content: "Company:"; }
    .leads-table td:nth-of-type(4):before { content: "Assigned To:"; }


    /* Adjust specific elements within table cells for mobile view */
    .contact-info { 
        text-align: right; 
        align-items: flex-end; /* Align contact info to the right */
    }
    .contact-info div { 
        text-align: right; 
        white-space: normal; /* Allow text to wrap for emails/phones */
        overflow: visible; /* Prevent ellipsis on mobile, allow full display */
        text-overflow: clip;
    }
    .select-dropdown { 
        max-width: 100%; /* Ensure dropdown takes full available width in its cell */
        width: 100%; /* Make it take 100% of its available space */
        text-align: right; 
        -webkit-appearance: none; /* Remove default arrow on some browsers */
        -moz-appearance: none;
        appearance: none;
        background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="%236c757d" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"></polyline></svg>');
        background-repeat: no-repeat;
        background-position: right 8px center;
        background-size: 16px;
        padding-right: 30px; /* Make space for the custom arrow */
    }
    .select-dropdown option { 
        text-align: left; 
    } /* Options text should still be left-aligned */

    /* ADJUSTED: Badge styling for mobile to prevent merging */
    .badge { 
        /* Removed float: right; and margin-left: 10px; */
        display: inline-block; /* Keep as inline-block to allow text-align on td to center/right-align */
        min-width: unset; /* Override min-width for mobile badges */
        width: auto; /* Allow badge to size naturally */
        margin-top: 5px; /* Add a small top margin for vertical separation from label */
        margin-left: 0; /* Ensure no unwanted left margin */
        text-align: center; /* Center text within badge */
    }
    /* Ensure the text inside the badge respects the parent's text-align: right */
    .leads-table td:nth-of-type(6) .badge,
    .leads-table td:nth-of-type(7) .badge {
        display: block; /* Make badge a block to ensure it's on its own line after the label */
        margin-left: auto; /* Push block-level badge to the right */
        margin-right: 0; /* Reset potential right margin */
    }
}

/* Smaller mobile screens (e.g., iPhone SE) */
@media (max-width: 480px) {
    .container {
        padding: 12px; /* Even less padding */
    }
    .dashboard-header h1 {
        font-size: 22px; /* Smaller header font */
    }
    .date-filter-bar {
        padding: 12px 15px; /* Adjust padding for filter bar */
    }
    .stat-card p {
        font-size: 24px; /* Smaller stat numbers */
    }
    .leads-table td {
        padding-left: 45%; /* Adjust padding for labels */
    }
    .leads-table td:before {
        width: 40%; /* Adjust label width */
    }
}
    </style>
</head>
<body>
    <div class="container">
        <div class="dashboard-header">
            <h1>
                <i class="bi bi-speedometer2"></i>
                {% if selected_category %}
                    {{ selected_category }} Management Dashboard
                {% else %}
                    Leads Management Dashboard
                {% endif %}
            </h1>
            <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                <a href="{% url 'uploadLeads' category_id %}" class="btn btn-primary">
                    <i class="bi bi-cloud-upload"></i> Upload Leads
                </a>
                <a href="{% url 'viewCategory' %}" class="btn btn-secondary">
                    <i class="bi bi-arrow-left"></i> Back to Categories
                </a>
            </div>
        </div>
        
        <div class="date-filter-bar">
            <form id="filterForm" method="GET" action="{% url 'adminDashboard' category_id %}" class="d-flex align-items-center gap-3 flex-wrap">
                <label for="createdOnDate">Created On:</label>
                <input type="date" id="createdOnDate" name="created_on_date" value="{{ current_created_on_date|default:'' }}">
                
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-filter"></i> Filter
                </button>
                <button type="button" class="btn btn-secondary" id="clearDateFilter">
                    <i class="bi bi-x-circle"></i> Clear
                </button>

                <label for="statusFilter">Status:</label>
                <select class="select-dropdown" id="statusFilter" name="status">
                    <option value="">All</option>
                    {% for status_value, status_label in status_choices %}
                        <option value="{{ status_value }}" {% if request.GET.status == status_value %}selected{% endif %}>
                            {{ status_label }}
                        </option>
                    {% endfor %}
                </select>

                <label for="priorityFilter">Priority:</label>
                <select class="select-dropdown" id="priorityFilter" name="priority">
                    <option value="">All</option>
                    {% for priority_value, priority_label in priority_choices %}
                        <option value="{{ priority_value }}" {% if request.GET.priority == priority_value %}selected{% endif %}>
                            {{ priority_label }}
                        </option>
                    {% endfor %}
                </select>

                <button type="submit" name="lead_filter" value="assigned" class="btn btn-primary {% if request.GET.lead_filter == 'assigned' %}active{% endif %}">
                    <i class="bi bi-person-check-fill"></i> Assigned Leads
                </button>
                <button type="submit" name="lead_filter" value="pending" class="btn btn-warning {% if request.GET.lead_filter == 'pending' %}active{% endif %}">
                    <i class="bi bi-person-x-fill"></i> Pending Leads
                </button>
            </form>
        </div>

        <div id="bulkAssignSection" style="display: none; margin-top: 20px; padding: 15px; background: var(--card-background); border-radius: var(--border-radius); box-shadow: var(--box-shadow); border: 1px solid var(--gray-light); justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
            <label for="bulkAssignSalesman" style="font-weight: 500; color: var(--dark); white-space: nowrap;">Assign selected leads to:</label>
            <select class="select-dropdown" id="bulkAssignSalesman" style="flex-grow: 1; max-width: 250px;">
                <option value="">— Select Salesman —</option>
                {% for user in users %}
                    {% if not user.is_staff %}
                        <option value="{{ user.id }}">
                            {{ user.email }}
                        </option>
                    {% endif %}
                {% endfor %}
            </select>
            <button type="button" class="btn btn-primary" id="assignSelectedBtn">
                <i class="bi bi-person-check-fill"></i> Assign Selected Leads
            </button>
        </div>

        <div class="stats-container">
            <div class="stat-card">
                <h3>Total Leads</h3>
                <p>{{ total_leads }}</p>
            </div>
            <div class="stat-card">
                <h3>Sales Team</h3>
                <p>{{ total_salesmen }}</p>
            </div>
            <div class="stat-card">
                <h3>New Leads</h3>
                <p><span class="stat-new-leads">{% if new_leads is not None %}{{ new_leads }}{% else %}—{% endif %}</span></p>
            </div>
            <div class="stat-card">
                <h3>Contacted Leads</h3>
                <p><span class="stat-contacted-leads">{% if contacted_leads is not None %}{{ contacted_leads }}{% else %}—{% endif %}</span></p>
            </div>
            <div class="stat-card">
                <h3>Converted Leads</h3>
                <p><span class="stat-converted-leads">{% if converted_leads is not None %}{{ converted_leads }}{% else %}—{% endif %}</span></p>
            </div>
        </div>

        <h2 class="section-header" id="leadsListHeader">Recent Leads</h2>
        <div class="table-container">
            <table class="leads-table">
                <thead>
                    <tr>
                        <th class="no-click">
                            <input type="checkbox" id="selectAllLeads">
                        </th>
                        <th>Contact Name</th>
                        <th>Company</th>
                        <th>Assigned To</th>
                    </tr>
                </thead>
                <tbody>
                    {% if leads %} {# Check if leads iterable is not empty #}
                        {% for lead in leads %}
                        <tr class="clickable-row" data-href="{% url 'viewLead' lead.id %}">
                            <td class="no-click">
                                <input type="checkbox" name="selected_leads" value="{{ lead.id }}" class="lead-checkbox">
                            </td>
                            <td>
                                <div class="contact-name">{{ lead.name|default:"—" }}</div>
                                <div class="contact-role">{{ lead.role|default:"" }}</div>
                            </td>
                            <td>{{ lead.company|default:"—" }}</td>
                            <td class="no-click">
                                <select onchange="assignLead(this, {{ lead.id }})" class="select-dropdown">
                                    <option value="">— Select —</option>
                                    {% for user in users %}
                                        {% if not user.is_staff %}
                                            <option value="{{ user.id }}" {% if lead.assigned_to and user.id == lead.assigned_to.id %}selected{% endif %}>
                                                {{ user.email }}
                                            </option>
                                        {% endif %}
                                    {% endfor %}
                                </select>
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                    <tr>
                        <td colspan="4" class="empty-state">No leads available for the selected criteria.</td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>

    </div>

    <script>
    // Make rows clickable except for the select dropdown area
    document.addEventListener('DOMContentLoaded', function() {
    // --- Existing Clickable Row Logic ---
    const rows = document.querySelectorAll('.clickable-row');
    rows.forEach(row => {
        row.addEventListener('click', function(e) {
            if (e.target.closest('.no-click')) {
                return;
            }
            window.location.href = this.dataset.href;
        });
    });

    // --- Mobile Data Label Logic (correctly inside DOMContentLoaded) ---
    if (window.innerWidth <= 768) {
        const headers = document.querySelectorAll('.leads-table th');
        const tableRowsForLabels = document.querySelectorAll('.leads-table tbody tr'); // Renamed to avoid conflict
        headers.forEach((header, index) => {
            const label = header.textContent.trim();
            tableRowsForLabels.forEach(row => { // Use the renamed variable
                const cell = row.querySelectorAll('td')[index];
                if (cell) {
                    cell.setAttribute('data-label', label);
                }
            });
        });
    }

    // --- Table Row Animation Logic (correctly inside DOMContentLoaded) ---
    const tableRows = document.querySelectorAll('.leads-table tbody tr');
    tableRows.forEach((row, index) => {
        row.style.opacity = '0';
        row.style.transform = 'translateY(10px)';
        row.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
        
        setTimeout(() => {
            row.style.opacity = '1';
            row.style.transform = 'translateY(0)';
        }, 100 + (index * 50));
    });

    // --- Touch Feedback Logic (correctly inside DOMContentLoaded) ---
    const clickableRows = document.querySelectorAll('.clickable-row'); // Re-selecting for clarity, though `rows` above is same
    clickableRows.forEach(row => {
        row.addEventListener('touchstart', function() {
            this.style.backgroundColor = 'rgba(255, 215, 0, 0.1)';
        });
        
        row.addEventListener('touchend', function() {
            this.style.backgroundColor = '';
        });
    });

    // --- Date Filter Logic (correctly inside DOMContentLoaded) ---
    const clearDateFilterBtn = document.getElementById('clearDateFilter');
    const createdOnDateInput = document.getElementById('createdOnDate');
    const filterForm = document.getElementById('filterForm');

    if (clearDateFilterBtn) {
        clearDateFilterBtn.addEventListener('click', function() {
            createdOnDateInput.value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('priorityFilter').value = '';

            const tempInput = document.createElement('input');
            tempInput.type = 'hidden';
            tempInput.name = 'lead_filter';
            tempInput.value = 'all';
            filterForm.appendChild(tempInput);
            filterForm.submit();
        });
    }
    
    // --- Update "Recent Leads" Header (correctly inside DOMContentLoaded) ---
    const leadsListHeader = document.getElementById('leadsListHeader');
    const leadFilterParam = new URLSearchParams(window.location.search).get('lead_filter');
    const createdOnDateParam = new URLSearchParams(window.location.search).get('created_on_date');
    const statusFilterParam = new URLSearchParams(window.location.search).get('status');
    const priorityFilterParam = new URLSearchParams(window.location.search).get('priority');

    if (createdOnDateParam) {
        leadsListHeader.textContent = `Leads Created On ${createdOnDateParam}`;
    } else if (leadFilterParam === 'assigned') {
        leadsListHeader.textContent = 'Assigned Leads';
    } else if (leadFilterParam === 'pending') {
        leadsListHeader.textContent = 'Pending Leads';
    } else if (statusFilterParam && priorityFilterParam) {
        const statusText = document.querySelector(`#statusFilter option[value="${statusFilterParam}"]`).textContent;
        const priorityText = document.querySelector(`#priorityFilter option[value="${priorityFilterParam}"]`).textContent;
        leadsListHeader.textContent = `${statusText} & ${priorityText} Leads`;
    } else if (statusFilterParam) {
        const statusText = document.querySelector(`#statusFilter option[value="${statusFilterParam}"]`).textContent;
        leadsListHeader.textContent = `${statusText} Leads`;
    } else if (priorityFilterParam) {
        const priorityText = document.querySelector(`#priorityFilter option[value="${priorityFilterParam}"]`).textContent;
        leadsListHeader.textContent = `${priorityText} Leads`;
    } else {
        leadsListHeader.textContent = 'All Leads (Current Category)';
    }

    // --- Active Button Styling Logic (correctly inside DOMContentLoaded) ---
    const filterButtons = document.querySelectorAll('#filterForm button[name="lead_filter"]');
    // Note: 'allLeadsDateClearBtn' was defined but not used here, and there's no button with 'value="all"'
    // We should add an "All Leads" button for consistency if it's meant to be selectable.
    // For now, let's just make sure the existing logic for active states is sound.

    function updateActiveButtonStyles() {
        filterButtons.forEach(btn => btn.classList.remove('active'));
        const filterDateSubmitBtn = document.querySelector('.date-filter-bar button[type="submit"].btn-primary');
        if (filterDateSubmitBtn) { // Check if the element exists before trying to modify it
            filterDateSubmitBtn.classList.remove('active');
        }
        clearDateFilterBtn.classList.remove('active');

        const currentLeadFilter = new URLSearchParams(window.location.search).get('lead_filter');
        const currentCreatedOnDate = new URLSearchParams(window.location.search).get('created_on_date');
        const currentStatusFilter = new URLSearchParams(window.location.search).get('status');
        const currentPriorityFilter = new URLSearchParams(window.location.search).get('priority');

        if (currentCreatedOnDate) {
            if (filterDateSubmitBtn) { // Check if the element exists
                filterDateSubmitBtn.classList.add('active');
            }
        } else if (currentLeadFilter === 'assigned') {
            const assignedBtn = document.querySelector('.btn[value="assigned"]');
            if (assignedBtn) assignedBtn.classList.add('active');
        } else if (currentLeadFilter === 'pending') {
            const pendingBtn = document.querySelector('.btn[value="pending"]');
            if (pendingBtn) pendingBtn.classList.add('active');
        } else if (currentLeadFilter === 'all' || (!currentLeadFilter && !currentCreatedOnDate && !currentStatusFilter && !currentPriorityFilter)) {
            // There's no button with value="all" in your HTML currently.
            // If you want an "All Leads" button to be active by default or when cleared, you need to add it.
            // Example: <button type="submit" name="lead_filter" value="all" class="btn btn-info">All Leads</button>
            // For now, this condition will correctly identify the 'all' state.
            const allLeadsBtn = document.querySelector('.btn[value="all"]'); // This will be null if no such button exists
            if (allLeadsBtn) allLeadsBtn.classList.add('active');
        }

        if (currentCreatedOnDate || (!currentLeadFilter && !currentStatusFilter && !currentPriorityFilter)) {
            clearDateFilterBtn.classList.add('active');
        }
    }

    // Add event listeners to Status and Priority dropdowns to trigger form submission
    document.getElementById('statusFilter').addEventListener('change', function() {
        filterForm.submit();
    });
    document.getElementById('priorityFilter').addEventListener('change', function() {
        filterForm.submit();
    });

    // Call it on page load
    updateActiveButtonStyles();

    // --- Bulk Assignment Logic (This is the crucial part that needs to always run) ---
    // Re-declare or re-select these elements every time DOMContentLoaded fires
    const selectAllCheckbox = document.getElementById('selectAllLeads');
    const leadCheckboxes = document.querySelectorAll('.lead-checkbox');
    const bulkAssignSection = document.getElementById('bulkAssignSection');
    const bulkAssignSalesmanSelect = document.getElementById('bulkAssignSalesman');
    const assignSelectedBtn = document.getElementById('assignSelectedBtn');

    function toggleBulkAssignSection() {
        // Ensure leadCheckboxes is re-queried or correctly reflects the current DOM
        const currentLeadCheckboxes = document.querySelectorAll('.lead-checkbox'); // IMPORTANT: Re-query here
        const anyChecked = Array.from(currentLeadCheckboxes).some(checkbox => checkbox.checked);
        bulkAssignSection.style.display = anyChecked ? 'flex' : 'none';
    }

    if (selectAllCheckbox) { // Check if selectAllCheckbox exists
        selectAllCheckbox.addEventListener('change', function() {
            // Re-query leadCheckboxes here too to ensure they are current
            const currentLeadCheckboxes = document.querySelectorAll('.lead-checkbox');
            currentLeadCheckboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
            toggleBulkAssignSection();
        });
    }

    // Attach listeners to individual lead checkboxes
    leadCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', toggleBulkAssignSection);
    });

    if (assignSelectedBtn) { // Check if assignSelectedBtn exists
        assignSelectedBtn.addEventListener('click', function() {
            const selectedLeadIds = Array.from(document.querySelectorAll('.lead-checkbox')) // Re-query here
                                            .filter(checkbox => checkbox.checked)
                                            .map(checkbox => checkbox.value);
            const assignedToUserId = bulkAssignSalesmanSelect.value;

            if (selectedLeadIds.length === 0) {
                alert('Please select at least one lead to assign.');
                return;
            }

            if (!assignedToUserId) {
                alert('Please select a salesman to assign the leads to.');
                return;
            }

            if (!confirm(`Are you sure you want to assign ${selectedLeadIds.length} lead(s) to the selected salesman?`)) {
                return;
            }

            assignSelectedBtn.textContent = 'Assigning...';
            assignSelectedBtn.disabled = true;

            fetch("{% url 'bulk_assign_leads_ajax' %}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": "{{ csrf_token }}"
                },
                body: JSON.stringify({
                    lead_ids: selectedLeadIds,
                    user_id: assignedToUserId
                })
            })
            .then(response => response.json())
            .then(data => {
                assignSelectedBtn.textContent = 'Assign Selected Leads';
                assignSelectedBtn.disabled = false;
                if (data.success) {
                    alert(data.message);
                    location.reload();
                } else {
                    alert("Failed to assign leads: " + data.error);
                }
            })
            .catch(error => {
                assignSelectedBtn.textContent = 'Assign Selected Leads';
                assignSelectedBtn.disabled = false;
                console.error("Error during bulk lead assignment:", error);
                alert("Something went wrong during bulk lead assignment.");
            });
        });
    }


    // Individual Lead Assignment
    function assignLead(selectElem, leadId) {
        const userId = selectElem.value;
        const row = selectElem.closest('tr');
        const cell = row.querySelector('td.no-click');
        const originalSelect = selectElem.cloneNode(true);

        selectElem.style.display = 'none';
        const loadingSpan = document.createElement('span');
        loadingSpan.className = 'loading';
        loadingSpan.textContent = 'Assigning...';
        cell.appendChild(loadingSpan);

        fetch("{% url 'assign_lead_ajax' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": "{{ csrf_token }}"
            },
            body: JSON.stringify({
                lead_id: leadId,
                user_id: userId
            })
        })
        .then(response => response.json())
        .then(data => {
            loadingSpan.remove();
            selectElem.style.display = '';
            if (data.success) {
                if (userId) {
                    for (let i = 0; i < selectElem.options.length; i++) {
                        selectElem.options[i].selected = (selectElem.options[i].value == userId);
                    }
                } else {
                    selectElem.selectedIndex = 0;
                }
                row.style.backgroundColor = 'rgba(76, 201, 240, 0.1)';
                setTimeout(() => {
                    row.style.backgroundColor = '';
                }, 1000);
            } else {
                alert("Failed to assign lead: " + data.error);
                cell.innerHTML = '';
                cell.appendChild(originalSelect);
            }
        })
        .catch(error => {
            loadingSpan.remove();
            selectElem.style.display = '';
            console.error("Error during lead assignment:", error);
            alert("Something went wrong during lead assignment.");
            cell.innerHTML = '';
            cell.appendChild(originalSelect);
        });
    }
    window.assignLead = assignLead;
});
    </script>
</body>
</html>